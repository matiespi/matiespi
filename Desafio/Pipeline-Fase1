pipeline {
    agent any
     parameters {
            string(name: 'NOMBRE_APELLIDO', defaultValue: '', description: 'Ingrese nombre y apellido')
            string(name: 'MAIL', defaultValue: '', description: 'Ingrese mail para enviar info')
            choice(name: 'DEPARTAMENTO', choices: ['Contabilidad', 'Finanzas', 'Tecnologia'], description: 'Asigne un departamento')
    }
    stages {
        stage('Download-File') 
        {
            steps {
                script{
                    sh'''
                        cd /tmp/
                        curl -O https://raw.githubusercontent.com/matiespi/matiespi/main/Desafio/script.sh
                        chmod +x script.sh
                        ls -l script.sh
                    '''
                }
            }
        }
        stage('Execution') 
        {
            steps {
                script{
                    sh'''
                        cd /tmp/
                        temporalPassword = $(openssl rand -base64 12 | tr -d '\n')
                        echo "${temporalPassword}"
                        resultado = sh(script: "./script.sh \"$NOMBRE_APELLIDO\" \"$DEPARTAMENTO\" \"$temporalPassword\"")

                        echo "${resultado}"
                    '''
                }
            }
        }
        stage('Send-Notification') 
        {
            steps {
                script{
                    emailext (
                        to: '${MAIL}',
                        subject: 'Contraseña Temporal - ${NOMBRE_APELLIDO}',
                        body: "Usuario: ${resultado} - Tu contraseña temporal es: ${temporalPassword}. Deberás cambiarla en tu primer inicio de sesión.",
                        mimeType: 'text/plain'
                    )
                        echo "Contraseña temporal generada y enviada correctamente."
                }
            }
        }
        
    }
}